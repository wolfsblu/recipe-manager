<script lang="ts">
    import { Button } from '$lib/components/ui/button';
    import * as DropdownMenu from '$lib/components/ui/dropdown-menu';
    import * as Dialog from '$lib/components/ui/dialog';
    import { Badge } from '$lib/components/ui/badge';
    import { shoppingStore } from '$lib/stores/shopping.svelte';
    import { deleteShoppingList, updateShoppingList } from '$lib/api/shopping/shopping.svelte';
    import { Input } from "$lib/components/ui/input/index.js";
    import { toast } from 'svelte-sonner';
    import ChevronDownIcon from '@lucide/svelte/icons/chevron-down';
    import PlusIcon from '@lucide/svelte/icons/plus';
    import EditIcon from '@lucide/svelte/icons/edit-2';
    import TrashIcon from '@lucide/svelte/icons/trash-2';
    import CheckIcon from '@lucide/svelte/icons/check';
    import XIcon from '@lucide/svelte/icons/x';

    interface Props {
        onCreateNewList: () => void;
    }

    let { onCreateNewList }: Props = $props();

    let editingListId = $state<number | null>(null);
    let editingName = $state('');
    let dropdownOpen = $state(false);
    let showDeleteDialog = $state(false);
    let deleteListData = $state<{ id: number; name: string } | null>(null);
    let isDeleting = $state(false);

    const handleSelectList = (listId: number) => {
        shoppingStore.setCurrentListId(listId);
    };

    const startEdit = (listId: number, currentName: string) => {
        editingListId = listId;
        editingName = currentName;
        dropdownOpen = false;
    };

    const cancelEdit = () => {
        editingListId = null;
        editingName = '';
    };

    const saveEdit = async () => {
        if (!editingListId || !editingName.trim()) return;

        try {
            const updatedList = await updateShoppingList(editingListId, { name: editingName.trim() });
            shoppingStore.updateList(updatedList);
            toast.success('Shopping list renamed successfully');
            editingListId = null;
            editingName = '';
        } catch (error) {
            toast.error('Failed to rename shopping list');
        }
    };

    const showDeleteConfirmation = (listId: number, listName: string) => {
        dropdownOpen = false;
        deleteListData = { id: listId, name: listName };
        showDeleteDialog = true;
    };

    const confirmDelete = async () => {
        if (!deleteListData) return;

        isDeleting = true;
        try {
            await deleteShoppingList(deleteListData.id);
            shoppingStore.removeList(deleteListData.id);
            toast.success('Shopping list deleted successfully');
            showDeleteDialog = false;
            deleteListData = null;
        } catch (error) {
            toast.error('Failed to delete shopping list');
        } finally {
            isDeleting = false;
        }
    };

    const cancelDelete = () => {
        showDeleteDialog = false;
        deleteListData = null;
    };

    const handleKeyPress = (e: KeyboardEvent) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            saveEdit();
        } else if (e.key === 'Escape') {
            e.preventDefault();
            cancelEdit();
        }
    };

    const currentList = $derived(shoppingStore.currentList);
    const lists = $derived(shoppingStore.lists);
</script>

<div class="flex items-center justify-between">
    <div class="flex items-center gap-4">
        <DropdownMenu.Root bind:open={dropdownOpen}>
            <DropdownMenu.Trigger>
                {#snippet child({ props })}
                    <Button {...props} variant="outline" class="justify-between min-w-[200px]">
                        <span class="truncate">
                            {currentList ? currentList.name : 'Select a list'}
                        </span>
                        <ChevronDownIcon class="h-4 w-4 ml-2" />
                    </Button>
                {/snippet}
            </DropdownMenu.Trigger>
            <DropdownMenu.Content class="w-[var(--bits-dropdown-menu-anchor-width)] min-w-[var(--bits-dropdown-menu-anchor-width)]">
                {#each lists as list (list.id)}
                    <DropdownMenu.Item
                        class="flex items-center justify-between cursor-pointer"
                        onclick={() => handleSelectList(list.id)}
                    >
                        <span class="truncate">{list.name}</span>
                        {#if list.id === currentList?.id}
                            <CheckIcon class="h-4 w-4 text-primary" />
                        {/if}
                    </DropdownMenu.Item>
                {/each}
                
                <DropdownMenu.Separator />
                <DropdownMenu.Item onclick={onCreateNewList} class="cursor-pointer">
                    <PlusIcon />
                    Create New List
                </DropdownMenu.Item>
            </DropdownMenu.Content>
        </DropdownMenu.Root>
    </div>

    {#if currentList}
        <div class="flex items-center gap-2">
            <Button
                onclick={() => startEdit(currentList.id, currentList.name)}
                title="Rename list"
            >
                <EditIcon />
                <span class="hidden md:inline">Rename</span>
            </Button>
            <Button
                variant="destructive"
                onclick={() => showDeleteConfirmation(currentList.id, currentList.name)}
                title="Delete list"
            >
                <TrashIcon />
                <span class="hidden md:inline">Delete</span>
            </Button>
        </div>
    {/if}
</div>

<!-- Edit Dialog -->
<Dialog.Root open={editingListId !== null} onOpenChange={(open) => { if (!open) cancelEdit(); }}>
    <Dialog.Content class="sm:max-w-[425px]">
        <Dialog.Header>
            <Dialog.Title>Rename Shopping List</Dialog.Title>
        </Dialog.Header>
        <Input
            type="text"
            bind:value={editingName}
            onkeypress={handleKeyPress}
            placeholder="List name"
        />
        <Dialog.Footer>
            <Button onclick={saveEdit} disabled={!editingName.trim()}>
                Save
            </Button>
        </Dialog.Footer>
    </Dialog.Content>
</Dialog.Root>

<!-- Delete Confirmation Dialog -->
<Dialog.Root open={showDeleteDialog} onOpenChange={(open) => { if (!open) cancelDelete(); }}>
    <Dialog.Content class="sm:max-w-[425px]">
        <Dialog.Header>
            <Dialog.Title>Delete Shopping List</Dialog.Title>
            <Dialog.Description>
                Are you sure you want to delete "{deleteListData?.name}"? This action cannot be undone.
            </Dialog.Description>
        </Dialog.Header>
        
        <Dialog.Footer>
            <Button
                type="button"
                variant="outline"
                onclick={cancelDelete}
                disabled={isDeleting}
            >
                Cancel
            </Button>
            <Button 
                variant="destructive" 
                onclick={confirmDelete}
                disabled={isDeleting}
            >
                {isDeleting ? 'Deleting...' : 'Delete'}
            </Button>
        </Dialog.Footer>
    </Dialog.Content>
</Dialog.Root>